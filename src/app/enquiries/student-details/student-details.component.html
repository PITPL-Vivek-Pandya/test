<div class="main-content">
    <form [formGroup]="formGroup" novalidate (ngSubmit)="onSubmit()" *ngIf="loaded">
        <!-- Sticky Buttons Bar -->
        <div class="row sticky-button-bar">
            <div class="col-8" style="padding-left: 28px;" *ngIf="userInfo.isSysAdmin() || userInfo.isSchoolAdmin() || userInfo.isSchoolEditor()">
                <button class="btn btn-primary" type="button" (click)="attendAnPersonalTour()"
                    [disabled]="studentId === 0 || !activityLogsHaveLoaded">
                    <i class="material-icons">playlist_add</i>PERSONAL TOUR</button>
                <button class="btn btn-primary" type="button" (click)="attendAnEvent()"
                    [disabled]="studentId === 0 || eventsCount<1 || !activityLogsHaveLoaded">
                    <i class="material-icons">playlist_add</i>EVENT</button>
                <button class="btn btn-primary" type="button" (click)="addActivityLog()" [disabled]="studentId === 0">
                    <i class="material-icons">playlist_add</i>ACTIVITY</button>
                <button class="btn btn-primary" type="button" *ngIf="studentId > 0 && isEnabledAppModule" (click)="addApplication()">
                    <i class="material-icons">playlist_add</i>APPLICATION</button>
            </div>
            <div class="col-4" style="padding-right: 28px;">
                <button type="submit" mat-raised-button class="btn btn-success pull-right" [promiseBtn]="promiseForBtn"
                    [disabled]="!formGroup || !formGroup.valid || !formIsValid ||!relationshipTableIsValid || (formIsPristine && changed===0)">save
                </button>
                <button type="button" mat-raised-button class="btn btn-cancel pull-right mx-1" (click)="onCancel()">Cancel</button>
            </div>
        </div>

        <div class="container-fluid">
            <div class="row cards">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header card-header-icon card-header-primary">
                            <div class="card-icon">
                                <i class="material-icons-outlined">person</i>

                            </div>
                            <h4 class="card-title">
                                {{title}}
                                <ng-container *ngFor="let alumni of alumniContactRelationships; let i = index">
                                    <div class="pull-right" *ngIf="studentId>0"
                                        matTooltip="{{(alumni === '?') ? alumniText : alumni}}"
                                        matTooltipPosition="above">
                                        <i class="material-icons">school</i>
                                        <div [ngStyle]="{'right.px': (-3+(i*33))}" class="notification">
                                            {{alumni | truncate:[1, '']}}
                                        </div>
                                    </div>
                                </ng-container>
                            </h4>
                        </div>
                        <div class="card-body">
                            <app-edit-student [isModal]="false" [studentAdditionalJsonData]="studentAdditionalJsonData"
                                (childCmpData)="childCmpData($event)">
                            </app-edit-student>
                        </div>
                    </div>
                    <app-related-contacts-cmp *ngIf="studentId" [studentId]="studentId" [trigger]="trigger"
                        [showAddContactButton]="true" [showAddressData]="false" [hideRelationship]="false"
                        [isNewStudent]="isNewStudent" (formIsValid)="setValidation($event)"
                        (contactChanged)="contactChanged($event)"></app-related-contacts-cmp>
                    <app-related-contacts-for-new-student-cmp *ngIf="!studentId"
                        (contactRelationships)="newContactRelationships($event)" [hasPrimary]="hasPrimary">
                    </app-related-contacts-for-new-student-cmp>
                </div>
                <div class="col-lg-4">
                    <!-- admin user -->
                    <div class="card"
                        *ngIf="userInfo.isSysAdmin() || userInfo.isSchoolAdmin() || userInfo.isSchoolEditor()">
                        <div class="card-header card-header-icon card-header-primary">
                            <div class="card-icon">
                                <i class="material-icons-outlined">person</i>
                            </div>
                            <h4 class="card-title">Admin Use</h4>
                        </div>
                        <div class="card-body">
                            <div class="row py-1">
                                <div class="col-lg-6">Date Created</div>
                                <div class="col-lg-6 text-right">{{student.createdAt | localDate: timeZone : dateTime}}</div>
                            </div>
                            <div class="row py-1">
                                <div class="col-lg-6">Last Updated</div>
                                <div class="col-lg-6 text-right">{{student.updatedAt | localDate: timeZone : dateTime}}</div>
                            </div>
                            <div class="row py-1">
                                <div class="col-lg-6">{{brand.name}} ID</div>
                                <div class="col-lg-6 text-right">{{student.id}}</div>
                            </div>
                            <div class="row py-1">
                                <div class="col-lg-6 py-lg-3">School ID</div>
                                <div class="col-lg-6 text-right">
                                    <mat-form-field [ngClass]="{'mat-form-field-disabled': isExternalIdReadonly}">
                                        <input matInput formControlName="externalId" [maxLength]="externalIdMaxLength"
                                            [readonly]="isExternalIdReadonly">
                                        <button type="button" mat-icon-button matSuffix class="text-success"
                                            (click)="isExternalIdReadonly = !isExternalIdReadonly">
                                            <mat-icon>{{ isExternalIdReadonly ? 'edit' : 'check' }}</mat-icon>
                                        </button>
                                    </mat-form-field>
                                </div>
                            </div>

                            <div class="row py-1 mb-2">
                                <div class="col-lg-6">Stage</div>
                                <div class="col-lg-6">
                                    <b>{{!stage ? '' : stage.name | translate}}</b>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <mat-form-field>
                                        <mat-select placeholder="Student Status" formControlName="studentStatusId"
                                            (selectionChange)="statusChanged($event.value)">
                                            <mat-option *ngFor="let studentStatus of studentStatuses" [value]="studentStatus.id" class="mat-option">
                                                {{studentStatus.status}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                            </div>

                            <mat-form-field>
                                <mat-select placeholder="Financial Aid" formControlName="financialAidId">
                                    <mat-option [value]="null">{{noItemSelected}} </mat-option>
                                    <mat-option *ngFor="let financialAid of financialAids" [value]="financialAid.id">
                                        {{financialAid.name}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>

                            <div class="row">
                                <div class="col-9">
                                    <label>Flag Student</label>
                                </div>
                                <div class="col-3 text-right">
                                    <mat-checkbox formControlName="markRecord">
                                    </mat-checkbox>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <button [disabled]="studentId === 0" type="button" class="btn btn-outline-warning w-100"
                                        (click)="updateState()">DEFER / DECLINE</button>
                                </div>
                            </div>

                            <div class="card-body card-gray mb-2">
                                <div class="row py-1">
                                    <div class="col-lg-12">
                                        <h4>Student Information System</h4>
                                    </div>
                                </div>
                                <div class="row py-1">
                                    <div class="col-lg-12">
                                        {{ (managementSystem.id === mngSysNa) ? '' : managementSystem.name }}
                                    </div>
                                </div>
                                <div class="row py-1">
                                    <div class="col-lg-5">Student Data:</div>
                                    <div *ngIf="student.isExported" class="col-lg-7">
                                        <span class="badge badge-success">EXPORTED {{isExportedFromApply ? 'from Apply' : ''}}</span>
                                    </div>
                                    <div *ngIf="!student.isExported" class="col-lg-6">
                                        <span class="badge badge-danger">NOT EXPORTED</span>
                                    </div>
                                </div>
                                <div *ngIf="student.isExported" class="row py-1">
                                    <div class="col-lg-5">Date Export:</div>
                                    <div class="col-lg-7">{{student.exportDate | localeDate: dateDelimiter}}</div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button mat-raised-button type="button" class="btn btn-primary w-75 mr-2"
                                            [disabled]="student.isExported"
                                            (click)="export(managementSystem.export2Xml, false, true)">
                                            MARK & EXPORT TO
                                            {{(managementSystem.format !== 'default') ? managementSystem.name : schoolManagementSystem }}
                                        </button>
                                        <button [disabled]="!student.isExported" mat-raised-button type="button"
                                            class="btn btn-just-icon btn-reset" (click)="resetExport()">
                                            <i class="material-icons">refresh</i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-12">
                                    <mat-form-field>
                                        <mat-label>Notes</mat-label>
                                        <textarea matInput formControlName="notes" placeholder="Enter in any notes here..."
                                            mat-autosize matAutosizeMinRows="3" matAutosizeMaxRows="5">
                                        </textarea>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- card -->
                    <div class="card">
                        <div class="card-header card-header-icon card-header-primary">
                            <div class="card-icon">
                                <i class="material-icons-outlined">info</i>
                            </div>
                            <h4 class="card-title">Research</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-12">
                                    <mat-form-field>
                                        <mat-select placeholder="Lead Source" formControlName="leadSourceId">
                                            <mat-option [value]="null">{{noItemSelected}} </mat-option>
                                            <mat-option *ngFor="let leadSource of leadSources" [value]="leadSource.id">
                                                {{leadSource.name}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <app-other-list-item formControlName="hearAboutUsId" placeholder="Hear About us"
                                        [list]="hearAboutUS" [listId]="listId.hear_about_us" htmlId="studentEditFormHearAboutUsId">
                                    </app-other-list-item>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <app-related-students-cmp *ngIf="studentId" [contactChangedTrigger]="contactChangedTrigger"
                        [studentId]="studentId"></app-related-students-cmp>
                </div>
            </div>

            <app-student-state *ngIf="studentStateData" [data]="studentStateData"
                (stage)="onStageChange($event)" (statusIsChanged)="onStudentStatusChange($event)">
            </app-student-state>

            <app-activity-logs *ngIf="userInfo.isSchoolEditorOrHigher() && student.id" [shouldShowActionButtons]="false" [student]="student"
                (alChanges)="activityLogsChanged($event)" (loaded)="activityLogsLoaded($event)">
            </app-activity-logs>

            <app-student-logs *ngIf="userInfo.isSysAdmin() && studentId !== 0" [trigger]="studentLogTrigger" [studentId]="studentId"></app-student-logs>
        </div>
    </form>
</div>
