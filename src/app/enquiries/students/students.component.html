<div class="main-content">
    <div class="container-fluid d-flex flex-column">
        <div class="row h-50 flex-grow-1">
            <div class="col-md-12 h-100">
                <div class="card my-0 h-100">
                    <div class="card-body d-flex flex-column h-100">
                        <div *ngIf="school && filterValues">
                            <app-enquiries-filter-student [values]="filterValues" [useLocalStorage]="useLocalStorage" [school]="school"
                                [filterName]="tableId" (onValuesChange)="onFilterChange($event)" (resetSearchText)="resetSearchText()">
                            </app-enquiries-filter-student>
                        </div>
                        <div class="row">
                            <div class="col-md-3 table-stats">
                                <div>{{studentsService.total}} Student(s)</div>
                                <span *ngIf="selectedCount > 0" class="select-count" style="cursor: default">
                                    {{selectedCount}} Selected
                                </span>
                            </div>
                            <div class="col-md-9 text-right">
                                <div class="mx-1 d-inline-block">
                                    <mat-form-field>
                                        <input matInput (keyup)="onSearchChange($event.target.value)" [value]="tableState.searchText" placeholder="Search...">
                                    </mat-form-field>
                                </div>
                                <button *ngIf="visibleSelectedCount > 0" type="button" class="btn btn-delete"
                                    (click)="removeSelected()">Delete Selected
                                </button>
                                <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown"
                                    aria-expanded="true">
                                    <i class="material-icons">get_app</i>DOWNLOAD<b class="caret"></b>
                                </button>
                                <div class="dropdown-menu" *ngIf="managementSystem">
                                    <option class="dropdown-item"
                                        (click)="export(managementSystem.export2Xml, isAllSelected(), true)"
                                        [attr.disabled]="visibleSelectedCount > 0 ? null : true">
                                        MARK & EXPORT SELECTED RECORDS TO
                                        {{ (managementSystem.id !== 'default') ? managementSystem.name: schoolManagementSystem }}
                                        (.{{(managementSystem.export2Xml)?'XML':'CSV'}})
                                    </option>
                                    <option class="dropdown-item" (click)="export(false, isAllSelected())"
                                        [attr.disabled]="visibleSelectedCount > 0 ? null : true">
                                        DOWNLOAD SELECTED RECORDS TO CSV
                                    </option>
                                    <option class="dropdown-item" (click)="export(false, true, false, true)"
                                        [attr.disabled]="students.length > 0 ? null : true">
                                        DOWNLOAD BACKUP
                                    </option>
                                </div>
                                <label class="btn-bs-file btn btn-primary text-white">Import
                                    <input #fileInput type="file" accept="{{allowedFormats.join(', ')}}"
                                        (change)="import()" />
                                </label>
                                <button class="btn btn-primary" (click)="addStudent()">
                                    <i class="material-icons">playlist_add</i>Add
                                </button>
                            </div>
                        </div>
                        <div id="studentsListTableContainer" class="table-responsive h-25 flex-grow-1"
                            infiniteScroll [infiniteScrollThrottle]="debounceTime" [infiniteScrollDistance]=".1" [scrollWindow]="false"
                            infiniteScrollContainer="#studentsListTableContainer" [fromRoot]="true" (scrolled)="onScrollDown()">
                            <table [id]="tableId" mat-table [dataSource]="dataSource" matSort
                                (matSortChange)="onSortChange($event)">
                                <!-- Checkbox Column -->
                                <ng-container matColumnDef="select">
                                    <th mat-header-cell *matHeaderCellDef class="pr-3 pt-2">
                                        <mat-checkbox (change)="$event ? masterToggle() : null"
                                            [checked]="selection.hasValue() && isAllSelected()"
                                            [indeterminate]="selection.hasValue() && isPartiallySelected()">
                                        </mat-checkbox>
                                    </th>
                                    <td mat-cell *matCellDef="let row" class="pt-2">
                                        <mat-checkbox (click)="$event.stopPropagation()"
                                            (change)="$event ? selection.toggle(row) : null"
                                            [checked]="selection.isSelected(row)">
                                        </mat-checkbox>
                                    </td>
                                </ng-container>

                                <!-- isExported Column -->
                                <ng-container matColumnDef="isExported">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>
                                        <i [matTooltip]="'Exported'" matTooltipPosition="right"
                                            class="material-icons">save_alt</i>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <i *ngIf="element.isExported" [matTooltip]="element.exportInfo"
                                            matTooltipPosition="right" class="material-icons text-success">save_alt</i>
                                    </td>
                                </ng-container>

                                <!-- Name Column -->
                                <ng-container matColumnDef="name">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
                                    <td mat-cell *matCellDef="let element" class="l-cs"
                                        (click)="editStudent(element.id)">
                                        {{element.lastName}}, {{element.firstName}}
                                    </td>
                                </ng-container>

                                <!-- Score Column -->
                                <ng-container matColumnDef="score">
                                    <th mat-header-cell *matHeaderCellDef>Score</th>
                                    <td mat-cell *matCellDef="let element">{{element.score}}</td>
                                </ng-container>

                                <!-- StartingYear Column -->
                                <ng-container matColumnDef="startingYear">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Starting Year</th>
                                    <td mat-cell *matCellDef="let element">{{element.startingYear| startingYear: (startingMonth$ | async) : true}}</td>
                                </ng-container>

                                <!-- schoolIntakeYear Column -->
                                <ng-container matColumnDef="year">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>{{'et.year' | translate}}</th>
                                    <td mat-cell *matCellDef="let element">
                                        {{element.year}}
                                    </td>
                                </ng-container>

                                <!-- Stage Column -->
                                <ng-container matColumnDef="stage">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Stage</th>
                                    <td mat-cell *matCellDef="let element">{{element.stage | translate}}</td>
                                </ng-container>

                                <!-- Status Column -->
                                <ng-container matColumnDef="status">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                                    <td mat-cell *matCellDef="let element">
                                        {{element.status}}
                                    </td>
                                </ng-container>

                                <!-- Contact Column -->
                                <ng-container matColumnDef="contactName">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Contact</th>
                                    <td mat-cell *matCellDef="let element" [ngClass]="{'l-cs':(element.contactId)}"
                                        (click)="editContact(element.contactId)">
                                        {{element.contactLastName}}, {{element.contactFirstName}}
                                    </td>
                                </ng-container>

                                <!-- Mobile Phone Column -->
                                <ng-container matColumnDef="contactMobile">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Mobile Phone</th>
                                    <td mat-cell *matCellDef="let element">{{element.contactMobile}}</td>
                                </ng-container>

                                <!-- Actions Column -->
                                <ng-container matColumnDef="actions">
                                    <th mat-header-cell *matHeaderCellDef> <span class="float-right">Actions</span></th>
                                    <td class="td-actions text-right" mat-cell *matCellDef="let element">
                                        <button mat-raised-button type="button" class="btn btn-success btn-link"
                                            matTooltip="Edit" matTooltipPosition="left"
                                            (click)="$event.stopPropagation(); editStudent(element.id)">
                                            <i class="material-icons">edit</i>
                                        </button>
                                        <button mat-raised-button type="button" class="btn btn-danger btn-link"
                                            matTooltip="Delete" matTooltipPosition="left"
                                            (click)="$event.stopPropagation(); deleteStudent(element.id)">
                                            <i class="material-icons">delete_outline</i>
                                        </button>
                                    </td>
                                </ng-container>

                                <!-- No Data -->
                                <ng-container matColumnDef="noData">
                                    <td mat-footer-cell *matFooterCellDef colspan="11" class="border-bottom-0">
                                        <app-table-spinner [getTableRows]="getTableRows"></app-table-spinner>

                                        <div [hidden]="!dataSource || !dataSource.filteredData || dataSource.filteredData.length === 0 ||
                                            dataSource.filteredData.length !== studentsService.total">end of the list
                                        </div>
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                                    (click)="selection.toggle(row)">
                                </tr>

                                <!-- No Data-->
                                <tr mat-footer-row *matFooterRowDef="['noData']" class="text-center"></tr>
                            </table>
                        </div>
                    </div>
                    <!-- end content-->
                </div>
                <!--  end card  -->
            </div>
            <!-- end col-md-12 -->
        </div>
        <!-- end row -->
    </div>
</div>