<div class="row" *ngIf="event">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header card-header-icon card-header-primary">
                <div class="card-icon">
                    <i class="material-icons-outlined">inventory</i>
                </div>
                <h4 class="card-title">{{ title }}</h4>
            </div>
            <div class="card-body">
                <div class="toolbar">
                    <div class="row">
                        <div class="col-xl-7">
                            <div class="row">
                                <div class="col-sm-3">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label>Registrants</label>
                                        </div>
                                    </div>
                                    <div class="form-check form-check-radio form-check-inline">
                                        <label class="form-check-label">
                                            <input class="form-check-input" type="radio" value="all"
                                                [checked]="filterBookings === 'all'"
                                                (change)="changeFilter($event.target.value)">All
                                            <span class="circle">
                                                <span class="check"></span>
                                            </span>
                                        </label>
                                    </div>
                                    <div class="form-check form-check-radio form-check-inline">
                                        <label class="form-check-label">
                                            <input class="form-check-input" type="radio" value="attended"
                                                [checked]="filterBookings === 'attended'"
                                                (change)="changeFilter($event.target.value)">Attended only
                                            <span class="circle">
                                                <span class="check"></span>
                                            </span>
                                        </label>
                                    </div>
                                    <mat-form-field *ngIf="event.isSubToursEnabled">
                                        <mat-select placeholder="Subtour" [formControl]="subTourFilterControl"
                                            (selectionChange)="subTourFilterChanged()">
                                            <mat-option [value]="null">{{noItemSelected}} </mat-option>
                                            <mat-option *ngFor="let item of event.subTours" [value]="item.id">
                                                {{item.name}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div class="col-sm-9">
                                    <app-statistic-panel [label]="'Families'" [points]="familiesCount || 0"
                                        [data]=firstVisitData (filteringData)="filteringDataChanged($event)"
                                        [pieChartData]="pieChartData" [classNames]="classNames">
                                    </app-statistic-panel>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-5">
                            <div class="row text-center">
                                <div class="col-md-12" [class.point-view-short]="isCheckinMode">
                                    <events-count-view [students]="studentsCount" [families]="familiesCount"
                                        [attending]="attendingsCount" [checkedIn]="checkedInCount" [isYellow]="isYellow"
                                        [isRed]="isRed"></events-count-view>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="row">
                    <div class="col-sm-8"></div>
                    <div class="col-sm-4">
                        <div class="float-right mx-2">
                            <mat-form-field>
                                <input matInput [disabled]="!dataSource" [value]="tableState.searchText"
                                    (keyup)="applyFilter($event.target.value)" placeholder="Search results">
                            </mat-form-field>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table mat-table [id]="tableId" [dataSource]="dataSource" matSort class="table-hover"
                        (matSortChange)="onSortChange($event)" matSortActive="date" matSortDirection="desc">

                        <!-- status Column -->
                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let element">
                                <i
                                    class="material-icons md-16 mt-2 {{element.isFirstVisit ? 'silver-text' : element.isFirstVisit === false ? 'gold-text' : 'bronze-text'}}">lens</i>
                            </td>
                        </ng-container>

                        <!-- contacts Column -->
                        <ng-container matColumnDef="contacts">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Contact(s)</th>
                            <td mat-cell *matCellDef="let element">
                                <ul class="list-unstyled">
                                    <li *ngFor="let contact of element.contacts">
                                        <a [routerLink]="[contactUrl, { contactId: contact.id }]" class="l-cs"
                                        *ngIf="!isCheckinMode; else unclickableContact">
                                            {{contact.name}}
                                        </a>
                                        <ng-template #unclickableContact>{{contact.name}}</ng-template>
                                    </li>
                                </ul>
                            </td>
                        </ng-container>

                        <!-- students Column -->
                        <ng-container matColumnDef="students">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Student(s)</th>
                            <td mat-cell *matCellDef="let element">
                                <ul class="list-unstyled">
                                    <li *ngFor="let student of element.students">
                                        <a [routerLink]="[studentUrl, { studentId: student.id }]" class="l-cs"
                                            *ngIf="!isCheckinMode; else unclickableStudent">
                                            {{student.name}}
                                        </a>
                                        <ng-template #unclickableStudent>{{student.name}}</ng-template>
                                        {{(
                                            student.schoolIntakeYearId || student.startingYear ||
                                            (event.school.isBoardingEnabled && student.boardingType) || student.submittedApplication
                                                ? '(' +
                                                    (student.schoolIntakeYearId ? (student.schoolIntakeYear.name | abbr) : '-') + ', ' +
                                                    (student.startingYear ? (student.startingYear| startingYear: (startingMonth$ | async)) : '-') + ', ' +
                                                    (event.school.isBoardingEnabled ? ((student.boardingType ? (student.boardingType.name | slice:0:1) : '-') + ', ') : '') +
                                                    (student.submittedApplication ? (student.submittedApplication | slice:0:1) : '-') +
                                                ')'
                                                : ''
                                        )}}
                                    </li>
                                </ul>
                            </td>
                        </ng-container>

                        <!-- totalRSVP Column -->
                        <ng-container matColumnDef="totalRSVP">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>RSVP</th>
                            <td mat-cell *matCellDef="let element">
                                {{element.totalRSVP}}</td>
                        </ng-container>

                        <!-- checkedIn Column -->
                        <ng-container matColumnDef="checkedIn">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Checked In</th>
                            <td mat-cell *matCellDef="let element">
                                {{element.checkedIn}}</td>
                        </ng-container>

                        <!-- totalcheckedIn Column -->
                        <ng-container matColumnDef="totalcheckedIn">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Total</th>
                            <td mat-cell *matCellDef="let element">
                                {{element.totalcheckedIn}}</td>
                        </ng-container>

                        <!-- Message Column -->
                        <ng-container matColumnDef="message">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Message</th>
                            <td mat-cell [ngClass]="{'l-cs': element.message && element.message != '-'}"
                                (click)="showMessage(element)" *matCellDef="let element">
                                {{ (element.message && element.message.length>15) ? (element.message | slice:0:14) + '...' : element.message}}
                            </td>
                        </ng-container>

                        <!-- Tour Column -->
                        <ng-container matColumnDef="tour">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Subtour(s)</th>
                            <td mat-cell *matCellDef="let element">
                                <ng-container *ngFor="let subTour of element.subTours; let i = index">
                                    {{subTour.name}}<br />
                                </ng-container>
                            </td>
                        </ng-container>

                        <!-- conduct Column -->
                        <ng-container matColumnDef="conduct">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Agreed</th>
                            <td mat-cell *matCellDef="let element">
                                {{element.conduct}}</td>
                        </ng-container>

                        <!-- Actions Column -->
                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef> <span class="float-right">Actions</span></th>
                            <!--
                            Stop click propagation otherwises one click does two things and is confusing.
                            See https://stackoverflow.com/questions/44325592/angular2-clickable-table-row-except-last-cell
                            -->
                            <td class="td-actions text-right" (click)="$event.stopPropagation();" mat-cell *matCellDef="let element">
                                <button mat-raised-button type="button" class="btn btn-info btn-link check-in"
                                    matTooltip="CheckIn/CheckOut" matTooltipPosition="left"
                                    (click)="checkInBooking(element)">
                                    <i class="material-icons"
                                        *ngIf="element.checkedInCount === 0">check_box_outline_blank</i>
                                    <i class="material-icons"
                                        *ngIf="element.checkedInCount === element.totalAttendees && element.checkedInCount !== 0">check_box</i>
                                    <i class="material-icons"
                                        *ngIf="(element.totalAttendees > element.checkedInCount && element.checkedInCount > 0) ||
                                        (element.totalAttendees < element.checkedInCount) && element.checkedInCount > 0">indeterminate_check_box</i>
                                </button>
                                <button mat-raised-button type="button" class="btn btn-success btn-link"
                                    matTooltip="Edit" matTooltipPosition="left" (click)="editBookingModal(element)">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button mat-raised-button type="button" class="btn btn-danger btn-link remove"
                                    matTooltip="Remove" matTooltipPosition="left"
                                    *ngIf="!isCheckinMode" (click)="deleteBooking(element)">
                                    <i class="material-icons">close</i>
                                </button>
                            </td>
                        </ng-container>

                        <!-- No Data -->
                        <ng-container matColumnDef="noData">
                            <td [hidden]="!dataSource || (dataSource && dataSource.filteredData && dataSource.filteredData.length > 0)"
                                mat-footer-cell *matFooterCellDef colspan="11">
                                {{noDataInTable}}
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row (click)="editBookingModalRepresentative(row)" [class.clickable]="isCheckinMode"
                            *matRowDef="let row; columns: displayedColumns;"></tr>
                        <tr mat-footer-row *matFooterRowDef="['noData']" class="text-center"></tr>
                        <!-- No Data-->
                    </table>
                </div>
                <mat-paginator (page)="onPaginatorChange($event)"></mat-paginator>

                <div class="text-right">
                    <button
                    *ngIf="!isCheckinMode && dataSource && dataSource.filteredData && dataSource.filteredData.length > 0"
                        mat-raised-button class="btn btn-primary" type="button" (click)="downloadAttendees()">
                        <i class="material-icons">get_app</i>DOWNLOAD ATTENDEES
                    </button>
                    <button mat-raised-button class="btn btn-primary" type="button" (click)="selectContact()">
                        <i class="material-icons">playlist_add</i>REGISTER ATTENDEES
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<app-show-message *ngIf="showCurrentMessage" [triggershowMessage]="triggershowMessage" [message]="message"></app-show-message>
